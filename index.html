<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Viral+</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

<style>
body{margin:0;font-family:Inter;background:#0f172a;color:#e5e7eb}
header{display:flex;justify-content:space-between;align-items:center;padding:12px;background:#020617}
button{background:#3b82f6;color:#fff;border:none;padding:8px 14px;border-radius:8px;font-weight:700;cursor:pointer}
input,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid #334155;background:#020617;color:#fff;margin-bottom:8px}
.panel{padding:12px;margin:12px;border:1px solid #334155;border-radius:12px}
.feed{height:70vh;overflow-y:auto}
.post{margin-bottom:16px;border-radius:12px;overflow:hidden;background:#020617}
.post img,.post video{width:100%;max-height:400px;object-fit:cover}
.actions{display:flex;gap:10px;padding:8px}
.hidden{display:none}
</style>
</head>

<body>

<header>
  <strong>ðŸ”¥ Viral+</strong>
  <span id="userLabel">InvitÃ©</span>
</header>

<div id="auth" class="panel">
  <h3>Connexion / Inscription</h3>
  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="Mot de passe">
  <button onclick="signup()">CrÃ©er compte</button>
  <button onclick="login()">Connexion</button>
</div>

<div id="app" class="hidden">

  <div class="panel">
    <textarea id="postText" placeholder="Exprime-toi..."></textarea>
    <input type="file" id="postFile">
    <button onclick="publish()">Publier</button>
  </div>

  <div class="feed" id="feed"></div>

  <div class="panel">
    <h3>Messages</h3>
    <input id="dmText" placeholder="Message">
    <button onclick="sendDM()">Envoyer</button>
    <div id="chat"></div>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyDnxGbKIWzj2LKEwrh1a36z0jXMJfPEKTQ",
  authDomain: "viralplus-dfe4a.firebaseapp.com",
  projectId: "viralplus-dfe4a",
  storageBucket: "viralplus-dfe4a.appspot.com",
  appId: "1:719277208432:web:bf8585bfcf00962b87d5b5"
};

const appFB = initializeApp(firebaseConfig);
const auth = getAuth(appFB);
const db = getFirestore(appFB);
const storage = getStorage(appFB);

// ELEMENTS
const authDiv = document.getElementById("auth");
const appDiv = document.getElementById("app");
const feed = document.getElementById("feed");
const chat = document.getElementById("chat");

// AUTH
window.signup = async ()=>{
  await createUserWithEmailAndPassword(auth,email.value,password.value);
};

window.login = async ()=>{
  await signInWithEmailAndPassword(auth,email.value,password.value);
};

onAuthStateChanged(auth,user=>{
  if(user){
    authDiv.classList.add("hidden");
    appDiv.classList.remove("hidden");
    userLabel.textContent = user.email;
    loadFeed();
    loadMessages();
  }
});

// FEED
function loadFeed(){
  const q = query(collection(db,"posts"), orderBy("created","desc"));
  onSnapshot(q,snap=>{
    feed.innerHTML="";
    snap.forEach(d=>{
      const p=d.data();
      const div=document.createElement("div");
      div.className="post";

      if(p.media){
        if(p.type.startsWith("video")){
          const v=document.createElement("video");
          v.src=p.media; v.controls=true;
          div.appendChild(v);
        } else {
          const i=document.createElement("img");
          i.src=p.media;
          div.appendChild(i);
        }
      }

      const t=document.createElement("div");
      t.style.padding="8px";
      t.textContent=p.text;
      div.appendChild(t);

      const a=document.createElement("div");
      a.className="actions";
      const like=document.createElement("button");
      like.textContent="â¤ï¸ "+(p.likes||0);
      like.onclick=()=>likePost(d.id);
      a.appendChild(like);
      div.appendChild(a);

      feed.appendChild(div);
    });
  });
}

async function likePost(id){
  await updateDoc(doc(db,"posts",id),{
    likes: increment(1)
  });
}

// PUBLISH
window.publish = async ()=>{
  let url="", type="";
  if(postFile.files[0]){
    const f=postFile.files[0];
    const r=ref(storage,"posts/"+Date.now()+"_"+f.name);
    await uploadBytes(r,f);
    url=await getDownloadURL(r);
    type=f.type;
  }
  await addDoc(collection(db,"posts"),{
    text:postText.value,
    media:url,
    type:type,
    likes:0,
    created:serverTimestamp()
  });
  postText.value="";
  postFile.value="";
};

// MESSAGES
function loadMessages(){
  const q=query(collection(db,"messages"),orderBy("created"));
  onSnapshot(q,snap=>{
    chat.innerHTML="";
    snap.forEach(d=>{
      const p=document.createElement("p");
      p.textContent=d.data().from+" : "+d.data().text;
      chat.appendChild(p);
    });
  });
}

window.sendDM = async ()=>{
  await addDoc(collection(db,"messages"),{
    from:auth.currentUser.email,
    text:dmText.value,
    created:serverTimestamp()
  });
  dmText.value="";
};
</script>

</body>
</html>
