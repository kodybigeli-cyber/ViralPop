<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Viral+</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:Inter,Arial,sans-serif;
  background:#000;
  color:#fff;
  overflow:hidden;
}

/* HEADER */
header{
  position:fixed;
  top:0;
  width:100%;
  z-index:10;
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:12px;
  background:rgba(0,0,0,.4);
}
header strong{font-size:20px}
header button{
  background:#3b82f6;
  border:none;
  color:#fff;
  padding:6px 12px;
  border-radius:8px;
  font-weight:700;
}

/* FEED */
#feed{
  height:100vh;
  overflow-y:scroll;
  scroll-snap-type:y mandatory;
}
.post{
  height:100vh;
  position:relative;
  scroll-snap-align:start;
  background:#000;
}
.post video,
.post img{
  width:100%;
  height:100%;
  object-fit:cover;
}

/* OVERLAY */
.overlay-bottom{
  position:absolute;
  bottom:80px;
  left:12px;
  right:80px;
}
.overlay-bottom .author{font-weight:800}
.overlay-bottom .text{margin-top:6px;font-size:15px}

.actions{
  position:absolute;
  right:12px;
  bottom:120px;
  display:flex;
  flex-direction:column;
  gap:14px;
}
.actions button{
  background:rgba(0,0,0,.5);
  border:none;
  color:#fff;
  width:48px;
  height:48px;
  border-radius:50%;
  font-size:18px;
}

/* POPULARITY WIDGET */
#popWidget{
  position:fixed;
  top:70px;
  right:10px;
  z-index:15;
  background:rgba(0,0,0,.55);
  border-radius:14px;
  padding:10px;
  width:280px;
  backdrop-filter:blur(6px);
}
.battery{
  width:100%;
  height:18px;
  border:2px solid #22d3ee;
  border-radius:12px;
  overflow:hidden;
  margin-bottom:8px;
}
.energy{
  height:100%;
  width:0%;
  background:linear-gradient(90deg,#22d3ee,#3b82f6);
  transition:width .4s ease;
}
#popGraph{
  width:100%;
  height:140px;
  background:#020617;
  border-radius:10px;
}

/* AUTH */
#authModal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.8);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:20;
}
.authBox{
  background:#020617;
  padding:20px;
  border-radius:16px;
  width:90%;
  max-width:360px;
}
.authBox input{
  width:100%;
  padding:10px;
  margin-bottom:10px;
  border-radius:8px;
  border:1px solid #334155;
  background:#020617;
  color:#fff;
}
.authBox button{
  width:100%;
  padding:10px;
  border:none;
  border-radius:10px;
  background:#3b82f6;
  color:#fff;
  font-weight:800;
}
</style>
</head>

<body>

<header>
  <strong>ðŸ”¥ Viral+</strong>
  <button id="loginBtn">Connexion</button>
</header>

<div id="feed"></div>

<!-- POPULARITY -->
<div id="popWidget">
  <div class="battery"><div class="energy" id="energy"></div></div>
  <canvas id="popGraph" width="260" height="140"></canvas>
</div>

<!-- AUTH -->
<div id="authModal">
  <div class="authBox">
    <h3>Connexion / Inscription</h3>
    <input id="email" placeholder="Email">
    <input id="password" type="password" placeholder="Mot de passe">
    <button onclick="login()">Continuer</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { getFirestore, collection, onSnapshot, query, orderBy, doc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDnxGbKIWzj2LKEwrh1a36z0jXMJfPEKTQ",
  authDomain: "viralplus-dfe4a.firebaseapp.com",
  projectId: "viralplus-dfe4a",
  storageBucket: "viralplus-dfe4a.appspot.com",
  appId: "1:719277208432:web:bf8585bfcf00962b87d5b5"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const feed = document.getElementById("feed");
const authModal = document.getElementById("authModal");
document.getElementById("loginBtn").onclick = ()=> authModal.style.display="flex";

/* AUTH */
window.login = async ()=>{
  try{
    await signInWithEmailAndPassword(auth,email.value,password.value);
  }catch{
    await createUserWithEmailAndPassword(auth,email.value,password.value);
  }
  authModal.style.display="none";
};

onAuthStateChanged(auth,user=>{
  document.getElementById("loginBtn").style.display = user ? "none" : "block";
});

/* FEED */
const q = query(collection(db,"posts"), orderBy("created","desc"));
onSnapshot(q,snap=>{
  feed.innerHTML="";
  snap.forEach(d=>{
    const p=d.data();
    const post=document.createElement("div");
    post.className="post";

    let media;
    if(p.type?.startsWith("video")){
      media=document.createElement("video");
      media.src=p.media;
      media.loop=true;
      media.muted=true;
      media.autoplay=true;
      media.playsInline=true;
    }else{
      media=document.createElement("img");
      media.src=p.media;
    }
    post.appendChild(media);

    const bottom=document.createElement("div");
    bottom.className="overlay-bottom";
    bottom.innerHTML=`<div class="author">@${p.author||"anonyme"}</div><div class="text">${p.text||""}</div>`;
    post.appendChild(bottom);

    const actions=document.createElement("div");
    actions.className="actions";
    const like=document.createElement("button");
    like.innerHTML="â¤ï¸";
    like.onclick=()=> updateDoc(doc(db,"posts",d.id),{likes:increment(1)});
    actions.appendChild(like);
    post.appendChild(actions);

    feed.appendChild(post);
  });
});

/* POPULARITY */
const energy=document.getElementById("energy");
const ctx=document.getElementById("popGraph").getContext("2d");
let stats={text:[],video:[],interact:[]};

onSnapshot(collection(db,"posts"),snap=>{
  let posts=0,videos=0,likes=0;
  snap.forEach(d=>{
    const p=d.data();
    posts++;
    if(p.type?.startsWith("video")) videos++;
    likes+=p.likes||0;
  });

  energy.style.width=Math.min(100,posts*5+likes*2)+"%";

  stats.text.push(posts);
  stats.video.push(videos);
  stats.interact.push(likes);
  if(stats.text.length>20){stats.text.shift();stats.video.shift();stats.interact.shift();}

  ctx.clearRect(0,0,260,140);
  [[stats.text,"#f59e0b"],[stats.video,"#22d3ee"],[stats.interact,"#a3e635"]].forEach(line=>{
    ctx.beginPath();
    ctx.strokeStyle=line[1];
    line[0].forEach((v,i)=>{
      const x=i/(line[0].length-1||1)*260;
      const y=140-(v/100)*140;
      i?ctx.lineTo(x,y):ctx.moveTo(x,y);
    });
    ctx.stroke();
  });
});
</script>

</body>
</html>
