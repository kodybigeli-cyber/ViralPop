<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Viral+ Ultimate Feed</title>
<link rel="stylesheet" href="style.css">

<!-- Google AdSense -->
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8210705555437597" crossorigin="anonymous"></script>

<style>
body {margin:0; font-family:sans-serif; background:#000;}
.feed-video {width:100%; height:90vh; object-fit:cover; display:block; margin-bottom:10px; scroll-snap-align:start;}
.video-wrapper {position:relative; scroll-snap-align:start;}
.actions-bar {position:absolute; right:10px; bottom:50px; display:flex; flex-direction:column; gap:10px;}
.actions-bar button {background:rgba(0,0,0,0.6); color:#fff; border:none; font-size:18px; padding:10px 12px; border-radius:50%; cursor:pointer;}
.top-bar {position:fixed; top:0; left:0; width:100%; display:flex; justify-content:space-between; align-items:center; padding:10px; background:rgba(0,0,0,0.5); z-index:100;}
#stats-bar {display:flex; gap:15px; color:#fff; font-weight:bold; align-items:center;}
#badge-bar {height:8px; background:#555; border-radius:5px; overflow:hidden; width:150px;}
#badge-fill {height:100%; background:#0f0; width:0%; transition:width 0.5s;}
.comment-box {position:absolute; right:10px; bottom:50px; width:30%; max-height:200px; overflow-y:auto; background:rgba(0,0,0,0.5); color:#fff; padding:5px; border-radius:10px; display:none;}
.comment-input {width:70%; padding:5px;}
.comment-btn {padding:5px 10px;}
.influencer-badge {position:absolute; top:10px; right:10px; background:#ff0; color:#000; padding:3px 7px; border-radius:5px; font-weight:bold;}
</style>

</head>
<body>

<!-- Barre supÃ©rieure -->
<div class="top-bar">
  <img src="logo.png" alt="Viral+ Logo" style="height:40px;">
  <div id="stats-bar">
    <span id="likesCount">0 Likes</span>
    <span id="popCount">0 Pop+</span>
    <div id="badge-bar"><div id="badge-fill"></div></div>
  </div>
</div>

<div id="feed-container" style="scroll-snap-type: y mandatory; overflow-y: scroll; height:100vh;"></div>

<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage.js"></script>

<script>
/********* Firebase Config *********/
const firebaseConfig = {
  apiKey: "AIzaSyDnxGbKIWzj2LKEwrh1a36z0jXMJfPEKTQ",
  authDomain: "viralplus-dfe4a.firebaseapp.com",
  projectId: "viralplus-dfe4a",
  storageBucket: "viralplus-dfe4a.appspot.com",
  messagingSenderId: "719277208432",
  appId: "1:719277208432:web:bf8585bfcf00962b87d5b5"
};

const app = firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

/********* Utilisateur *********/
let currentUser = null;
auth.onAuthStateChanged(user => {
  if(user) currentUser = user.uid;
  else {
    const params = new URLSearchParams(window.location.search);
    if(params.get("mode") === "guest") currentUser = "guest_" + Date.now();
    else window.location.href = "auth.html";
  }
});

/********* Charger posts *********/
const feedContainer = document.getElementById("feed-container");

db.collection("posts").orderBy("createdAt","desc").onSnapshot(snapshot => {
  feedContainer.innerHTML = "";
  snapshot.forEach(async doc => {
    const data = doc.data();

    const videoEl = document.createElement("video");
    videoEl.src = data.videoURL;
    videoEl.controls = false;
    videoEl.autoplay = true;
    videoEl.loop = true;
    videoEl.className = "feed-video";

    const wrapper = document.createElement("div");
    wrapper.className = "video-wrapper";
    wrapper.appendChild(videoEl);

    // Badge influenceur
    const badge = document.createElement("div");
    badge.className = "influencer-badge";
    const likesSnap = await db.collection("posts").doc(doc.id).collection("likes").get();
    const popsSnap = await db.collection("posts").doc(doc.id).collection("pop").get();
    const score = likesSnap.size + popsSnap.size;
    badge.innerText = score >= 50 ? "ðŸ”¥ VIP" : "â­";
    wrapper.appendChild(badge);

    // Commentaires
    const commentBox = document.createElement("div");
    commentBox.className = "comment-box";
    const commentInput = document.createElement("input");
    commentInput.className = "comment-input";
    commentInput.placeholder = "Ã‰crire un commentaire...";
    const commentBtn = document.createElement("button");
    commentBtn.className = "comment-btn";
    commentBtn.innerText = "Envoyer";
    commentBtn.onclick = async () => {
      if(currentUser && commentInput.value.trim() !== ""){
        await db.collection("posts").doc(doc.id).collection("comments").add({
          uid: currentUser,
          text: commentInput.value,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        commentInput.value = "";
      }
    };
    commentBox.appendChild(commentInput);
    commentBox.appendChild(commentBtn);
    wrapper.appendChild(commentBox);

    // Actions
    const actions = document.createElement("div");
    actions.className = "actions-bar";

    const likeBtn = document.createElement("button");
    likeBtn.innerText = "ðŸ‘";
    likeBtn.onclick = async () => { await db.collection("posts").doc(doc.id).collection("likes").doc(currentUser).set({uid:currentUser}); updateStats(doc.id); }

    const dislikeBtn = document.createElement("button");
    dislikeBtn.innerText = "ðŸ‘Ž";
    dislikeBtn.onclick = async () => { await db.collection("posts").doc(doc.id).collection("dislikes").doc(currentUser).set({uid:currentUser}); updateStats(doc.id); }

    const popBtn = document.createElement("button");
    popBtn.innerText = "âš¡ Pop+";
    popBtn.onclick = async () => { await db.collection("posts").doc(doc.id).collection("pop").doc(currentUser).set({uid:currentUser}); updateStats(doc.id); }

    const boostBtn = document.createElement("button");
    boostBtn.innerText = "ðŸš€ Boost";
    boostBtn.onclick = () => { alert("Boost sponsorisÃ© activÃ© !"); /* Ici futur code paiement / promotion */ }

    actions.appendChild(likeBtn);
    actions.appendChild(dislikeBtn);
    actions.appendChild(popBtn);
    actions.appendChild(boostBtn);
    wrapper.appendChild(actions);

    // Toggle commentaires
    videoEl.onclick = () => {
      commentBox.style.display = commentBox.style.display==="block"?"none":"block";
    }

    feedContainer.appendChild(wrapper);
  });
});

/********* Stats et barre badge *********/
async function updateStats(postId){
  const likes = await db.collection("posts").doc(postId).collection("likes").get();
  const pops = await db.collection("posts").doc(postId).collection("pop").get();
  document.getElementById("likesCount").innerText = likes.size + " Likes";
  document.getElementById("popCount").innerText = pops.size + " Pop+";
  const fillPercent = Math.min(100,(pops.size/50)*100);
  document.getElementById("badge-fill").style.width = fillPercent+"%";
}

/********* Autoplay vidÃ©o *********/
const observer = new IntersectionObserver(entries=>{
  entries.forEach(entry=>{ if(entry.isIntersecting) entry.target.play(); else entry.target.pause(); });
},{threshold:0.75});

const videoEls = document.getElementsByClassName("feed-video");
Array.from(videoEls).forEach(v=>observer.observe(v));

</script>
</body>
</html>
