<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <!-- Favicon (onglet navigateur) -->
<link rel="icon" href="icons/viral-32.png" type="image/png" sizes="32x32">

<!-- Apple touch icon (iOS Safari) -->
<link rel="apple-touch-icon" href="icons/viral-192.png">

<!-- PWA manifest (Android + Chrome) -->
<link rel="manifest" href="/manifest.webmanifest">

<!-- Couleur de l‚ÄôUI mobile -->
<meta name="theme-color" content="#0f172a">
  <title>Viral+ ‚Äî R√©seau social</title>
  <meta name="theme-color" content="#0f172a"/>

  <!-- AdSense (optionnel, placements pr√©vus) -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8210705555437597" crossorigin="anonymous"></script>

  <!-- Design sombre bleu/indigo, moderne et addictif -->
  <style>
    :root{
      --bg1:#0f172a; --bg2:#1e293b; --card:#111827; --panel:#0b1220;
      --text:#e5e7eb; --muted:#94a3b8; --primary:#3b82f6; --primary-2:#2563eb;
      --accent:#22d3ee; --success:#22c55e; --danger:#ef4444; --warning:#f59e0b;
      --line1:#f59e0b; --line2:#22d3ee; --line3:#a3e635;
      --glow:0 0 24px rgba(34,211,238,.18);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:Inter,Segoe UI,Arial,sans-serif;
      background: radial-gradient(1200px 600px at 20% 0%, var(--bg1) 0%, var(--bg2) 60%, #0a0f1c 100%);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:50;
      background:linear-gradient(90deg,#0f172a,#1e293b);
      border-bottom:1px solid rgba(255,255,255,.06);
      padding:12px 16px; display:flex; align-items:center; justify-content:space-between;
      backdrop-filter:blur(6px);
    }
    .brand{ font-weight:800; letter-spacing:.3px; font-size:20px }
    .badges{ display:flex; gap:8px }
    .badge{ background:#0b1220; border:1px solid rgba(255,255,255,.08); color:#cbd5e1; padding:6px 10px; border-radius:999px; font-size:12px; font-weight:700; box-shadow:var(--glow) }

    nav{
      display:flex; gap:8px; padding:10px; justify-content:center;
      background:#0b1220; border-bottom:1px solid rgba(255,255,255,.06);
    }
    nav button{
      background:var(--primary); border:none; color:#fff; padding:10px 14px; border-radius:14px; font-weight:700; cursor:pointer; transition:.25s; box-shadow:0 8px 20px rgba(59,130,246,.25)
    }
    nav button:hover{ background:var(--primary-2); transform:translateY(-1px) }
    nav button.active{ background:var(--accent); color:#001; box-shadow:0 8px 20px rgba(34,211,238,.25) }

    main{ max-width:1100px; margin:auto; padding:16px }
    .layout{ display:grid; grid-template-columns: 1fr 340px; gap:16px }
    @media(max-width:980px){ .layout{ grid-template-columns: 1fr } }

    .module{
      background:linear-gradient(180deg, #0f172a, #0b1220);
      border:1px solid rgba(255,255,255,.06);
      border-radius:18px; padding:16px; margin-bottom:16px; box-shadow:var(--glow)
    }
    .section-title{ margin:0 0 10px 0; font-weight:800; letter-spacing:.2px }

    input, textarea{
      width:100%; padding:10px; border-radius:12px; border:1px solid rgba(255,255,255,.08);
      background:#0b1220; color:#fff; margin-top:6px;
    }
    input::placeholder, textarea::placeholder{ color:#94a3b8 }
    .btn{
      background:var(--primary); color:#fff; border:none; border-radius:12px; padding:10px 14px; font-weight:800; cursor:pointer; transition:.2s; box-shadow:0 8px 20px rgba(59,130,246,.25)
    }
    .btn:hover{ background:var(--primary-2) }
    .btn.danger{ background:var(--danger) }
    .btn.success{ background:var(--success); color:#001 }
    .btn.accent{ background:var(--accent); color:#001 }

    .post{
      background:#0b1220; border:1px solid rgba(255,255,255,.06);
      border-radius:14px; padding:12px; margin-bottom:12px; animation:fadeIn .35s ease;
    }
    @keyframes fadeIn{ from{opacity:0; transform:translateY(8px)} to{opacity:1; transform:none} }
    .post .meta{ font-size:12px; color:var(--muted); margin-bottom:6px }
    .post .author{ font-weight:700; color:#cbd5e1 }
    .post img,.post video{ width:100%; border-radius:12px; margin-top:8px; background:#000 }

    .actions{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px }
    .actions .btn{ display:flex; align-items:center; gap:6px }
    .actions .like{ background:var(--success); color:#001 }
    .actions .dislike{ background:var(--danger) }
    .actions .comment{ background:#1e293b }
    .actions .share{ background:var(--accent); color:#001 }

    .bubble{ background:#0f172a; border:1px solid rgba(255,255,255,.08); padding:8px; border-radius:10px; margin:6px 0; max-width:80% }
    .bubble.me{ background:var(--accent); color:#001; margin-left:auto }

    .battery{ width:100%; height:44px; border:2px solid var(--accent); border-radius:12px; position:relative; overflow:hidden; margin-top:10px; box-shadow:var(--glow) }
    .energy{ height:100%; width:0%; background:linear-gradient(90deg,#22d3ee,#3b82f6); transition:width .4s ease }
    .spark{ position:absolute; inset:0; background:radial-gradient(circle,#fff 10%,transparent 60%); opacity:.12; animation:spark .6s infinite alternate ease-in-out }
    @keyframes spark{ from{transform:translateX(-16px)} to{transform:translateX(16px)} }

    .legend{ display:flex; gap:12px; flex-wrap:wrap; margin-top:8px; font-size:13px; color:#cbd5e1 }
    .legend .item{ display:flex; align-items:center; gap:6px }
    .dot{ width:10px; height:10px; border-radius:50% }
    .dot.text{ background:var(--line1) } .dot.video{ background:var(--line2) } .dot.interact{ background:var(--line3) }

    canvas{ width:100%; height:280px; background:#0b1220; border:1px solid rgba(255,255,255,.06); border-radius:12px; margin-top:10px; display:block }

    .toast{ position:fixed; right:16px; bottom:16px; z-index:60; display:flex; flex-direction:column; gap:8px }
    .toast .msg{ background:#0b1220; border:1px solid rgba(34,211,238,.35); color:#22d3ee; padding:10px 12px; border-radius:12px; box-shadow:var(--glow); min-width:240px; font-weight:700 }

    .ad{ margin:16px 0 }
    .empty{ background:#0b1220; border:1px solid rgba(255,255,255,.06); border-radius:12px; padding:14px; text-align:center; color:#94a3b8 }
    .contacts{ display:flex; flex-direction:column; gap:8px; max-height:260px; overflow:auto }
    .contact{ display:flex; align-items:center; justify-content:space-between; background:#0b1220; border:1px solid rgba(255,255,255,.06); padding:8px; border-radius:12px; cursor:pointer }
    .contact .name{ font-weight:700; color:#cbd5e1 } .contact .status{ font-size:12px; color:#94a3b8 }
    .chat{ margin-top:10px; background:#0b1220; border:1px solid rgba(255,255,255,.06); border-radius:12px; padding:10px; max-height:260px; overflow:auto }
    .composer{ display:flex; gap:8px; margin-top:8px }
    .composer input{ flex:1 }
    .callbar{ display:flex; gap:8px; margin-top:8px }
  </style>
</head>

<body>
  <header>
    <div class="brand">‚ö° Viral+</div>
    <div class="badges">
      <div class="badge" id="badge-user">Invit√©</div>
      <div class="badge" id="badge-pop">Pop: 0</div>
      <div class="badge" id="badge-posts">Posts: 0</div>
    </div>
  </header>

  <nav id="nav" style="display:none">
    <button class="active" onclick="show('home', this)">Accueil</button>
    <button onclick="show('publish', this)">Publier</button>
    <button onclick="show('pop', this)">Popularit√©</button>
    <button onclick="show('messages', this)">Messages</button>
  </nav>

  <main>
    <!-- Auth -->
    <div id="auth" class="module">
      <h2 class="section-title">Connexion / Inscription</h2>
      <input id="auth-email" placeholder="Email"/>
      <input id="auth-pass" type="password" placeholder="Mot de passe"/>
      <div style="display:flex; gap:8px; margin-top:8px">
        <button class="btn success" onclick="signup()">Cr√©er un compte</button>
        <button class="btn accent" onclick="login()">Se connecter</button>
      </div>
      <div style="margin-top:8px; color:#94a3b8">Gratuit (Firebase Spark). Donn√©es en ligne, temps r√©el.</div>
    </div>

    <div id="app" style="display:none">
      <div class="layout">
        <!-- Home -->
        <div id="home" class="module">
          <h2 class="section-title">Fil d‚Äôactualit√©</h2>
          <div id="feed"></div>
          <div class="ad">
            <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-8210705555437597" data-ad-format="auto" data-full-width-responsive="true"></ins>
          </div>
        </div>

        <!-- Messages -->
        <div id="messages" class="module" style="display:none">
          <h2 class="section-title">Messages</h2>
          <div class="contacts" id="contacts"></div>
          <div class="callbar">
            <button class="btn success" onclick="startCall('audio')">Appel audio</button>
            <button class="btn accent" onclick="startCall('video')">Appel vid√©o</button>
            <button class="btn danger" onclick="endCall()">Raccrocher</button>
          </div>
          <div class="chat" id="chat"></div>
          <div class="composer">
            <input id="dmText" placeholder="√âcrire un message‚Ä¶"/>
            <button class="btn accent" onclick="sendDM()">Envoyer</button>
            <button class="btn" id="recBtn" onclick="recordAudio()">üéôÔ∏è</button>
            <input type="file" id="dmFile" accept="image/*,video/*,audio/*" onchange="sendDMFile()"/>
          </div>
        </div>
      </div>

      <!-- Publier -->
      <div id="publish" class="module" style="display:none">
        <h2 class="section-title">Publier</h2>
        <textarea id="text" placeholder="Exprime-toi‚Ä¶"></textarea>
        <input type="file" id="media" accept="image/*,video/*"/>
        <div style="display:flex; gap:8px; margin-top:8px">
          <button class="btn accent" onclick="publish()">Publier</button>
          <button class="btn danger" onclick="clearComposer()">Effacer</button>
        </div>
      </div>

      <!-- Popularit√© -->
      <div id="pop" class="module" style="display:none">
        <h2 class="section-title">√ânergie de popularit√©</h2>
        <div class="battery">
          <div class="energy" id="energy"></div>
          <div class="spark"></div>
        </div>
        <canvas id="graph" width="1000" height="280"></canvas>
        <div class="legend">
          <div class="item"><span class="dot text"></span>Texte/Image/Photo</div>
          <div class="item"><span class="dot video"></span>Vid√©os</div>
          <div class="item"><span class="dot interact"></span>Interactions (likes, com, dislikes)</div>
        </div>
      </div>

      <div class="ad">
        <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-8210705555437597" data-ad-format="auto" data-full-width-responsive="true"></ins>
      </div>
    </div>
  </main>

  <div class="toast" id="toast"></div>

  <!-- App logic + Firebase -->
  <script type="module">
    /* Firebase SDKs */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, doc, updateDoc, onSnapshot, query, orderBy, serverTimestamp, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    /* Config Firebase (tes cl√©s int√©gr√©es) */
    const firebaseConfig = {
      apiKey: "AIzaSyDnxGbKIWzj2LKEwrh1a36z0jXMJfPEKTQ",
      authDomain: "viralplus-dfe4a.firebaseapp.com",
      projectId: "viralplus-dfe4a",
      storageBucket: "viralplus-dfe4a.appspot.com",
      messagingSenderId: "719277208432",
      appId: "1:719277208432:web:bf8585bfcf00962b87d5b5"
    };

    /* Init */
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    /* UI helpers */
    function notify(message){
      const t = document.getElementById("toast");
      const m = document.createElement("div");
      m.className = "msg";
      m.textContent = message;
      t.appendChild(m);
      setTimeout(()=>{ m.style.opacity = "0"; m.style.transform = "translateY(6px)"; }, 2200);
      setTimeout(()=>{ t.removeChild(m); }, 2800);
    }
    window.show = function(id, btn){
      ["home","publish","pop","messages"].forEach(x=>{
        const el = document.getElementById(x);
        if(el) el.style.display = (x===id ? "block" : "none");
      });
      document.querySelectorAll("nav button").forEach(b=> b.classList.remove("active"));
      if(btn) btn.classList.add("active");
    }
    window.clearComposer = function(){
      document.getElementById("text").value = "";
      document.getElementById("media").value = "";
    }

    /* Auth */
    window.signup = async function(){
      const email = document.getElementById("auth-email").value.trim();
      const pass = document.getElementById("auth-pass").value.trim();
      if(!email || !pass){ notify("Remplis email et mot de passe"); return; }
      try{
        const cred = await createUserWithEmailAndPassword(auth, email, pass);
        await setDoc(doc(db, "profiles", cred.user.uid), {
          email, createdAt: serverTimestamp(), pop: 0
        });
        notify("Compte cr√©√©");
      }catch(e){ notify("Erreur: " + e.message); }
    }
    window.login = async function(){
      const email = document.getElementById("auth-email").value.trim();
      const pass = document.getElementById("auth-pass").value.trim();
      if(!email || !pass){ notify("Identifiants manquants"); return; }
      try{
        await signInWithEmailAndPassword(auth, email, pass);
        notify("Connect√©");
      }catch(e){ notify("Erreur: " + e.message); }
    }
    function enterApp(user){
      document.getElementById("auth").style.display = "none";
      document.getElementById("app").style.display = "block";
      document.getElementById("nav").style.display = "flex";
      document.getElementById("badge-user").textContent = user.email || "Utilisateur";
      subscribeFeed();
      subscribeContacts();
      subscribePopularity(user.uid);
      try{ (adsbygoogle=window.adsbygoogle||[]).push({}); }catch(e){}
    }
    onAuthStateChanged(auth, (user)=>{
      if(user){ enterApp(user); } else {
        document.getElementById("auth").style.display = "block";
        document.getElementById("app").style.display = "none";
        document.getElementById("nav").style.display = "none";
      }
    });

    /* Feed */
    const feedEl = document.getElementById("feed");
    function renderPost(docSnap){
      const p = docSnap.data();
      const d = document.createElement("div");
      d.className = "post";
      const date = p.createdAt?.toDate ? p.createdAt.toDate().toLocaleString() : "";
      d.innerHTML = `
        <div class="meta"><span class="author">${p.authorEmail || "Anonyme"}</span> ‚Ä¢ ${date}</div>
        ${p.text || ""}
      `;
      if(p.mediaUrl){
        if(p.mediaType && p.mediaType.startsWith("video")) d.innerHTML += `<video src="${p.mediaUrl}" controls></video>`;
        else d.innerHTML += `<img src="${p.mediaUrl}" alt="media">`;
      }
      const actions = document.createElement("div");
      actions.className = "actions";
      actions.innerHTML = `
        <button class="btn like">‚ù§Ô∏è ${p.likes || 0}</button>
        <button class="btn dislike">üëé ${p.dislikes || 0}</button>
        <button class="btn comment">üí¨ Commenter</button>
        <button class="btn share">üîó Partager</button>
        <button class="btn" title="DM">‚úâÔ∏è DM</button>
      `;
      actions.querySelector(".like").onclick = ()=> likePost(docSnap.id, (p.likes||0)+1);
      actions.querySelector(".dislike").onclick = ()=> dislikePost(docSnap.id, (p.dislikes||0)+1);
      actions.querySelector(".comment").onclick = ()=> commentPost(docSnap.id);
      actions.querySelector(".share").onclick = ()=> share(p.text || "");
      actions.querySelector(".btn[title='DM']").onclick = ()=> openDM(p.authorUid);
      d.appendChild(actions);

      if(p.comments && p.comments.length){
        p.comments.forEach(c=>{
          const cc = document.createElement("div");
          cc.className = "bubble";
          cc.textContent = `${c.author}: ${c.text}`;
          d.appendChild(cc);
        });
      }
      return d;
    }
    function subscribeFeed(){
      const q = query(collection(db, "posts"), orderBy("createdAt", "desc"));
      onSnapshot(q, (snap)=>{
        feedEl.innerHTML = "";
        document.getElementById("badge-posts").textContent = "Posts: " + snap.size;
        if(snap.empty){
          const empty = document.createElement("div");
          empty.className = "empty";
          empty.textContent = "Aucune publication pour l‚Äôinstant. Lance la premi√®re ‚ú®";
          feedEl.appendChild(empty);
          return;
        }
        let i = 0;
        snap.forEach(docSnap=>{
          const node = renderPost(docSnap);
          feedEl.appendChild(node);
          if(i===3){
            const ad = document.createElement("div");
            ad.className = "ad";
            ad.innerHTML = `<ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-8210705555437597" data-ad-format="auto" data-full-width-responsive="true"></ins>`;
            feedEl.appendChild(ad);
            try{ (adsbygoogle=window.adsbygoogle||[]).push({}); }catch(e){}
          }
          i++;
        });
      });
    }
    window.publish = async function(){
      const user = auth.currentUser;
      if(!user){ notify("Connecte-toi pour publier"); return; }
      const text = document.getElementById("text").value.trim();
      const file = document.getElementById("media").files[0];
      if(!text && !file){ notify("√âcris quelque chose ou ajoute un m√©dia"); return; }

      let mediaUrl = null, mediaType = null;
      if(file){
        const path = `posts/${user.uid}/${Date.now()}_${file.name}`;
        const ref = sRef(storage, path);
        await uploadBytes(ref, file);
        mediaUrl = await getDownloadURL(ref);
        mediaType = file.type;
      }
      await addDoc(collection(db, "posts"), {
        authorUid: user.uid,
        authorEmail: user.email,
        text,
        mediaUrl,
        mediaType,
        likes: 0,
        dislikes: 0,
        comments: [],
        createdAt: serverTimestamp(),
        type: mediaType?.startsWith("video") ? "video" : "text"
      });
      await bumpPopularity(user.uid, 5);
      document.getElementById("text").value = "";
      document.getElementById("media").value = "";
      notify("Publication ajout√©e");
    }
    async function likePost(id, val){
      const ref = doc(db, "posts", id);
      await updateDoc(ref, { likes: val });
      const user = auth.currentUser;
      if(user) await bumpPopularity(user.uid, 2);
      notify("Tu as aim√© une publication");
    }
    async function dislikePost(id, val){
      const ref = doc(db, "posts", id);
      await updateDoc(ref, { dislikes: val });
      const user = auth.currentUser;
      if(user) await bumpPopularity(user.uid, -1);
      notify("Tu n‚Äôas pas aim√© une publication");
    }
    async function commentPost(id){
      const text = prompt("Commentaire");
      if(!text || !text.trim()) return;
      const user = auth.currentUser;
      const ref = doc(db, "posts", id);
      const snap = await getDoc(ref);
      const data = snap.data();
      const comments = data.comments || [];
      comments.push({ author: user?.email || "Anonyme", text: text.trim(), ts: Date.now() });
      await updateDoc(ref, { comments });
      if(user) await bumpPopularity(user.uid, 1);
      notify("Commentaire ajout√©");
    }
    function share(text=""){
      const url = location.href;
      const msg = (text ? text + " ‚Äî " : "") + url;
      if(navigator.share){
        navigator.share({ title:"Viral+", text:msg, url });
        return;
      }
      window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, "_blank");
      window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`, "_blank");
      window.open(`https://t.me/share/url?url=${encodeURIComponent(url)}&text=${encodeURIComponent(msg)}`, "_blank");
    }

    /* Popularit√© + triple courbe */
    const energyEl = document.getElementById("energy");
    const graph = document.getElementById("graph");
    const ctx = graph.getContext("2d");
    let histText = Array(24).fill(0), histVideo = Array(24).fill(0), histInteract = Array(24).fill(0);
    let currentPop = 0;

    function draw(){
      energyEl.style.width = Math.min(currentPop, 100) + "%";
      ctx.clearRect(0,0,graph.width,graph.height);
      const padding = 32, w = graph.width - padding*2, h = graph.height - padding*2;

      // Grille: vertical (mois), horizontal (jours)
      ctx.strokeStyle = "rgba(255,255,255,.15)"; ctx.lineWidth = 1; ctx.beginPath();
      for(let m=0;m<=12;m++){ const x = padding + (w/12)*m; ctx.moveTo(x,padding); ctx.lineTo(x,padding+h); }
      for(let d=0;d<=24;d++){ const y = padding + (h/24)*d; ctx.moveTo(padding,y); ctx.lineTo(padding+w,y); }
      ctx.stroke();

      ctx.fillStyle = "rgba(255,255,255,.7)"; ctx.font = "12px Arial";
      ctx.fillText("Mois ‚Üí", padding + w - 50, padding - 10);
      ctx.save(); ctx.translate(padding - 18, padding + 20); ctx.rotate(-Math.PI/2); ctx.fillText("Jours ‚Üì", 0, 0); ctx.restore();

      const maxVal = Math.max(100, ...histText, ...histVideo, ...histInteract);
      function plotLine(data, color){
        ctx.strokeStyle = color; ctx.lineWidth = 2; ctx.beginPath();
        data.forEach((v,i)=>{
          const x = padding + (w/(data.length-1))*i;
          const y = padding + (h - (v/maxVal)*h);
          if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        });
        ctx.stroke();
      }
      plotLine(histText, getComputedStyle(document.documentElement).getPropertyValue('--line1').trim() || "#f59e0b");
      plotLine(histVideo, getComputedStyle(document.documentElement).getPropertyValue('--line2').trim() || "#22d3ee");
      plotLine(histInteract, getComputedStyle(document.documentElement).getPropertyValue('--line3').trim() || "#a3e635");
    }
    function subscribePopularity(uid){
      onSnapshot(doc(db, "profiles", uid), (snap)=>{
        const data = snap.data();
        currentPop = data?.pop || 0;
        document.getElementById("badge-pop").textContent = "Pop: " + currentPop;
        draw();
      });
      const q = query(collection(db, "posts"), orderBy("createdAt", "desc"));
      onSnapshot(q, (snap)=>{
        let t=0,v=0,i=0;
        snap.forEach(d=>{
          const p = d.data();
          if(p.type==="video") v++;
          else t++;
          i += (p.likes||0) + (p.dislikes||0) + (p.comments?.length||0);
        });
        histText.push(t); histText.shift();
        histVideo.push(v); histVideo.shift();
        histInteract.push(i); histInteract.shift();
        draw();
      });
    }
    async function bumpPopularity(uid, delta){
      const ref = doc(db, "profiles", uid);
      const snap = await getDoc(ref);
      if(!snap.exists()){
        await setDoc(ref, { pop: Math.max(0, delta), email: auth.currentUser?.email || "", createdAt: serverTimestamp() });
      }else{
        const val = Math.max(0, (snap.data().pop||0) + delta);
        await updateDoc(ref, { pop: val });
      }
    }
    setInterval(async ()=>{
      const user = auth.currentUser;
      if(!user) return;
      await bumpPopularity(user.uid, -1);
    }, 2000);

    /* Contacts & DM */
    const contactsEl = document.getElementById("contacts");
    const chatEl = document.getElementById("chat");
    let dmTarget = null;

    function subscribeContacts(){
      onSnapshot(collection(db, "profiles"), (snap)=>{
        contactsEl.innerHTML = "";
        snap.forEach(d=>{
          const u = d.id;
          if(auth.currentUser && u === auth.currentUser.uid) return;
          const el = document.createElement("div");
          el.className = "contact";
          el.innerHTML = `<div class="name">${d.data().email || "Utilisateur"}</div><div class="status">En ligne</div>`;
          el.onclick = ()=> openDM(u);
          contactsEl.appendChild(el);
        });
      });
    }
    function threadKey(a,b){ return [a,b].sort().join("__"); }
    window.openDM = function(target){
      dmTarget = target;
      show('messages', document.querySelectorAll("nav button")[3]);
      renderChat();
      subscribeChat();
    }
    function renderChat(){ chatEl.innerHTML = ""; }
    function subscribeChat(){
      if(!dmTarget || !auth.currentUser) return;
      const key = threadKey(auth.currentUser.uid, dmTarget);
      const q = query(collection(db, "dm", key, "msgs"), orderBy("ts", "asc"));
      onSnapshot(q, (snap)=>{
        chatEl.innerHTML = "";
        snap.forEach(m=>{
          const data = m.data();
          const b = document.createElement("div");
          b.className = "bubble" + (data.from===auth.currentUser.uid ? " me" : "");
          if(data.type === "text"){
            b.textContent = data.content;
          } else if(data.type === "audio"){
            const audio = document.createElement("audio");
            audio.controls = true; audio.src = data.content;
            b.appendChild(audio);
          } else if(data.type === "file"){
            const link = document.createElement("a");
