<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Viral+ Ultimate Feed</title>
<link rel="stylesheet" href="style.css">

<!-- Ezoic Integration Script -->
<script src="https://go.ezoic.net/ezoic/ezoic.js" async></script>

<style>
body {margin:0; font-family:sans-serif; background:#000;}
.feed-video {width:100%; height:90vh; object-fit:cover; display:block; margin-bottom:10px; scroll-snap-align:start;}
.video-wrapper {position:relative; scroll-snap-align:start;}
.actions-bar {position:absolute; right:10px; bottom:50px; display:flex; flex-direction:column; gap:10px;}
.actions-bar button {background:rgba(0,0,0,0.6); color:#fff; border:none; font-size:18px; padding:10px 12px; border-radius:50%; cursor:pointer;}
.top-bar {position:fixed; top:0; left:0; width:100%; display:flex; justify-content:space-between; align-items:center; padding:10px; background:rgba(0,0,0,0.5); z-index:100;}
#stats-bar {display:flex; gap:15px; color:#fff; font-weight:bold; align-items:center;}
#badge-bar {height:8px; background:#555; border-radius:5px; overflow:hidden; width:150px;}
#badge-fill {height:100%; background:#0f0; width:0%; transition:width 0.5s;}
.comment-box {position:absolute; right:10px; bottom:50px; width:30%; max-height:200px; overflow-y:auto; background:rgba(0,0,0,0.5); color:#fff; padding:5px; border-radius:10px; display:none;}
.comment-input {width:70%; padding:5px;}
.comment-btn {padding:5px 10px;}
.influencer-badge {position:absolute; top:10px; right:10px; background:#ff0; color:#000; padding:3px 7px; border-radius:5px; font-weight:bold;}
</style>
</head>
<body>

<!-- Barre sup√©rieure -->
<div class="top-bar">
  <img src="logo.png" alt="Viral+ Logo" style="height:40px;">
  <div id="stats-bar">
    <span id="likesCount">0 Likes</span>
    <span id="popCount">0 Pop+</span>
    <div id="badge-bar"><div id="badge-fill"></div></div>
  </div>
</div>

<div id="feed-container" style="scroll-snap-type: y mandatory; overflow-y: scroll; height:100vh; -webkit-overflow-scrolling: touch;"></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
/********* Supabase Config *********/
const SUPABASE_URL = "https://cjxyruudipzgfinchcgj.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNqeHlydXVkaXB6Z2ZpbmNoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzNjgxNDUsImV4cCI6MjA4Mzk0NDE0NX0.YSsDO1bsm0bzIq-MIz6DawHCIsX8SfTuN7FXxY4mdzA";
const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/********* Utilisateur invit√© *********/
let currentUser = "guest_" + Date.now(); // simple ID invit√©

/********* Charger posts *********/
const feedContainer = document.getElementById("feed-container");

async function loadPosts() {
  const { data: posts, error } = await supabase.from("posts").select("*").order("createdAt", { ascending: false });
  if(error) { console.error("Erreur Supabase posts:", error); return; }
  if(!posts || posts.length===0) { feedContainer.innerHTML = "<p style='color:white;text-align:center;margin-top:20px;'>Aucun contenu disponible</p>"; return; }

  feedContainer.innerHTML = "";
  const observer = new IntersectionObserver(entries=>{
    entries.forEach(entry=>{ if(entry.isIntersecting) entry.target.play(); else entry.target.pause(); });
  },{threshold:0.75});

  posts.forEach(async post => {
    const videoEl = document.createElement("video");
    videoEl.src = post.videoURL;
    videoEl.controls = false;
    videoEl.autoplay = true;
    videoEl.loop = true;
    videoEl.className = "feed-video";

    const wrapper = document.createElement("div");
    wrapper.className = "video-wrapper";
    wrapper.appendChild(videoEl);

    // Badge influenceur
    const { data: likes } = await supabase.from("likes").select("*").eq("post_id", post.id);
    const { data: pops } = await supabase.from("pop").select("*").eq("post_id", post.id);
    const score = (likes?.length || 0) + (pops?.length || 0);
    const badge = document.createElement("div");
    badge.className = "influencer-badge";
    badge.innerText = score >= 50 ? "üî• VIP" : "‚≠ê";
    wrapper.appendChild(badge);

    // Commentaires
    const commentBox = document.createElement("div");
    commentBox.className = "comment-box";
    const commentInput = document.createElement("input");
    commentInput.className = "comment-input";
    commentInput.placeholder = "√âcrire un commentaire...";
    const commentBtn = document.createElement("button");
    commentBtn.className = "comment-btn";
    commentBtn.innerText = "Envoyer";
    commentBtn.onclick = async () => {
      if(commentInput.value.trim() !== ""){
        await supabase.from("comments").insert([{ post_id: post.id, uid: currentUser, text: commentInput.value }]);
        commentInput.value = "";
      }
    };
    commentBox.appendChild(commentInput);
    commentBox.appendChild(commentBtn);
    wrapper.appendChild(commentBox);

    // Actions
    const actions = document.createElement("div");
    actions.className = "actions-bar";

    const likeBtn = document.createElement("button");
    likeBtn.innerText = "üëç";
    likeBtn.onclick = async () => { await supabase.from("likes").upsert({ post_id: post.id, uid: currentUser }); updateStats(post.id); }

    const dislikeBtn = document.createElement("button");
    dislikeBtn.innerText = "üëé";
    dislikeBtn.onclick = async () => { await supabase.from("dislikes").upsert({ post_id: post.id, uid: currentUser }); updateStats(post.id); }

    const popBtn = document.createElement("button");
    popBtn.innerText = "‚ö° Pop+";
    popBtn.onclick = async () => { await supabase.from("pop").upsert({ post_id: post.id, uid: currentUser }); updateStats(post.id); }

    const boostBtn = document.createElement("button");
    boostBtn.innerText = "üöÄ Boost";
    boostBtn.onclick = () => { alert("Boost sponsoris√© activ√© !"); }

    actions.appendChild(likeBtn);
    actions.appendChild(dislikeBtn);
    actions.appendChild(popBtn);
    actions.appendChild(boostBtn);
    wrapper.appendChild(actions);

    videoEl.onclick = () => { commentBox.style.display = commentBox.style.display==="block"?"none":"block"; }

    feedContainer.appendChild(wrapper);
    observer.observe(videoEl);
  });
}
loadPosts();

/********* Stats et barre badge *********/
async function updateStats(postId){
  const { data: likes } = await supabase.from("likes").select("*").eq("post_id", postId);
  const { data: pops } = await supabase.from("pop").select("*").eq("post_id", postId);
  document.getElementById("likesCount").innerText = (likes?.length||0) + " Likes";
  document.getElementById("popCount").innerText = (pops?.length||0) + " Pop+";
  const fillPercent = Math.min(100,(pops?.length/50)*100);
  document.getElementById("badge-fill").style.width = fillPercent+"%";
}
</script>
</body>
</html>
