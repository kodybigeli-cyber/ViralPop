<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Viral+ ‚Äî TikTok-like</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <!-- Icons & PWA -->
  <link rel="icon" href="icons/viral-32.png" type="image/png" sizes="32x32">
  <link rel="apple-touch-icon" sizes="192x192" href="icons/viral-192.png">
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0f172a">

  <!-- Styles -->
  <style>
    :root{
      --bg1:#0f172a; --bg2:#1e293b; --panel:#0b1220; --card:#111827;
      --text:#e5e7eb; --muted:#94a3b8; --primary:#3b82f6; --primary-2:#2563eb;
      --accent:#22d3ee; --success:#22c55e; --danger:#ef4444; --warning:#f59e0b;
      --line1:#f59e0b; --line2:#22d3ee; --line3:#a3e635; --glow:0 0 24px rgba(34,211,238,.18);
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family:Inter,Segoe UI,Arial,sans-serif;
      background: radial-gradient(1200px 600px at 20% 0%, var(--bg1) 0%, var(--bg2) 60%, #0a0f1c 100%);
      color:var(--text);
    }
    .topbar{
      position:sticky; top:0; z-index:50; display:flex; align-items:center; justify-content:space-between;
      background:linear-gradient(90deg,#0f172a,#1e293b); border-bottom:1px solid rgba(255,255,255,.06);
      padding:12px 16px; backdrop-filter:blur(6px);
    }
    .brand{ font-weight:800; letter-spacing:.3px; font-size:20px }
    .badges{ display:flex; gap:8px }
    .badge{ background:#0b1220; border:1px solid rgba(255,255,255,.08); color:#cbd5e1; padding:6px 10px; border-radius:999px; font-size:12px; font-weight:700; box-shadow:var(--glow) }
    .search{ display:flex; gap:8px; align-items:center }
    .search input{ background:#0b1220; border:1px solid rgba(255,255,255,.08); color:#fff; padding:8px 10px; border-radius:12px; width:280px }

    .tabs{
      display:flex; gap:8px; padding:10px; justify-content:center;
      background:#0b1220; border-bottom:1px solid rgba(255,255,255,.06);
    }
    .tab{
      background:var(--primary); border:none; color:#fff; padding:10px 14px; border-radius:14px; font-weight:700; cursor:pointer;
      transition: background .25s, transform .25s, box-shadow .25s; box-shadow:0 8px 20px rgba(59,130,246,.25)
    }
    .tab:hover{ background:var(--primary-2); transform:translateY(-1px) }
    .tab.active{ background:var(--accent); color:#001; box-shadow:0 8px 20px rgba(34,211,238,.25) }

    main{ max-width:1100px; margin:auto; padding:16px }
    .panel{
      background:linear-gradient(180deg, #0f172a, #0b1220);
      border:1px solid rgba(255,255,255,.06);
      border-radius:18px; padding:16px; margin-bottom:16px; box-shadow:var(--glow)
    }
    .row{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px }
    input, textarea{
      width:100%; padding:10px; border-radius:12px; border:1px solid rgba(255,255,255,.08);
      background:#0b1220; color:#fff; margin-top:6px;
    }
    input::placeholder, textarea::placeholder{ color:#94a3b8 }
    .btn{
      background:var(--primary); color:#fff; border:none; border-radius:12px; padding:10px 14px; font-weight:800; cursor:pointer;
      transition: background .25s, transform .25s, box-shadow .25s; box-shadow:0 8px 20px rgba(59,130,246,.25)
    }
    .btn:hover{ background:var(--primary-2); transform:translateY(-1px) }
    .btn.danger{ background:var(--danger) }
    .btn.success{ background:var(--success); color:#0f172a }
    .btn.accent{ background:var(--accent); color:#0f172a }
    .muted{ color:#94a3b8 }

    /* TikTok-like feed */
    .feed {
      height: 100vh;
      overflow-y: scroll;
      scroll-snap-type: y mandatory;
      background:#000;
      border-radius:12px;
    }
    .post {
      height: 100vh;
      scroll-snap-align: start;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #000;
    }
    .post video, .post img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      background:#000;
    }
    .overlay-top {
      position: absolute; top: 12px; left: 12px; right: 12px;
      display:flex; justify-content:space-between; align-items:center; color:#fff; text-shadow:0 2px 6px rgba(0,0,0,.6);
    }
    .overlay-top .author { font-weight:800 }
    .overlay-bottom {
      position: absolute; bottom: 16px; left: 16px; right: 16px; color:#fff; text-shadow:0 2px 6px rgba(0,0,0,.6);
    }
    .overlay-bottom .text { max-width: 70%; font-size:16px; line-height:1.4 }
    .actions {
      position: absolute; right: 20px; bottom: 100px;
      display: flex; flex-direction: column; gap: 12px;
    }
    .actions .btn {
      background: rgba(0,0,0,0.5);
      color: #fff;
      border-radius: 50%;
      width: 48px; height: 48px;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 6px 16px rgba(0,0,0,.35);
    }

    .battery{ width:100%; height:44px; border:2px solid var(--accent); border-radius:12px; position:relative; overflow:hidden; margin-top:10px; box-shadow:var(--glow) }
    .energy{ height:100%; width:0%; background:linear-gradient(90deg,#22d3ee,#3b82f6); transition:width .4s ease }
    .spark{ position:absolute; inset:0; background:radial-gradient(circle,#fff 10%,transparent 60%); opacity:.12; animation:spark .6s infinite alternate ease-in-out }
    @keyframes spark{ from{transform:translateX(-16px)} to{transform:translateX(16px)} }

    .legend{ display:flex; gap:12px; flex-wrap:wrap; margin-top:8px; font-size:13px; color:#cbd5e1 }
    .legend .item{ display:flex; align-items:center; gap:6px }
    .dot{ width:10px; height:10px; border-radius:50% }
    .dot.text{ background:var(--line1) } .dot.video{ background:var(--line2) } .dot.interact{ background:var(--line3) }

    canvas{ width:100%; height:280px; background:#0b1220; border:1px solid rgba(255,255,255,.06); border-radius:12px; margin-top:10px; display:block }

    .toast{ position:fixed; right:16px; bottom:16px; z-index:60; display:flex; flex-direction:column; gap:8px }
    .toast .msg{ background:#0b1220; border:1px solid rgba(34,211,238,.35); color:#22d3ee; padding:10px 12px; border-radius:12px; box-shadow:var(--glow); min-width:240px; font-weight:700; transition:opacity .6s, transform .6s }

    .contacts{ display:flex; flex-direction:column; gap:8px; max-height:260px; overflow:auto }
    .contact{ display:flex; align-items:center; justify-content:space-between; background:#0b1220; border:1px solid rgba(255,255,255,.06); padding:8px; border-radius:12px; cursor:pointer }
    .contact .name{ font-weight:700; color:#cbd5e1 } .contact .status{ font-size:12px; color:#94a3b8 }

    .chatbox{ flex:1; display:flex; flex-direction:column; gap:8px }
    .chat{ background:#0b1220; border:1px solid rgba(255,255,255,.06); border-radius:12px; padding:10px; max-height:260px; overflow:auto }
    .bubble{ background:#0f172a; border:1px solid rgba(255,255,255,.08); padding:8px; border-radius:10px; margin:6px 0; max-width:80% }
    .bubble.me{ background:var(--accent); color:#0f172a; margin-left:auto }
    .composer{ display:flex; gap:8px; }
    .composer input{ flex:1 }

    .rtc{ display:flex; gap:8px; }
    .rtc video{ width:48%; background:#000; border-radius:12px }

    .profile-card{ display:flex; gap:12px; align-items:center }
    .avatar img, .avatar video{ width:96px; height:96px; border-radius:50%; object-fit:cover; background:#000 }
  </style>

  <!-- AdSense (optionnel) -->
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8210705555437597" crossorigin="anonymous"></script>
</head>
<body>
  <header class="topbar">
    <div class="brand">‚ö° Viral+</div>
    <div class="search">
      <input id="searchInput" placeholder="Rechercher des utilisateurs ou des posts‚Ä¶"/>
      <button class="btn" id="searchBtn">Rechercher</button>
    </div>
    <div class="badges">
      <div class="badge" id="badge-user">Invit√©</div>
      <div class="badge" id="badge-pop">Pop: 0</div>
      <div class="badge" id="badge-posts">Posts: 0</div>
    </div>
  </header>

  <nav class="tabs">
    <button class="tab active" data-tab="home">Accueil</button>
    <button class="tab" data-tab="publish">Publier</button>
    <button class="tab" data-tab="pop">Popularit√©</button>
    <button class="tab" data-tab="messages">Messages</button>
    <button class="tab" data-tab="profile">Profil</button>
  </nav>

  <main>
    <!-- Auth -->
    <section id="auth" class="panel">
      <h2>Connexion / Inscription</h2>
      <input id="auth-email" placeholder="Email"/>
      <input id="auth-pass" type="password" placeholder="Mot de passe"/>
      <div class="row">
        <button class="btn success" id="signupBtn">Cr√©er un compte</button>
        <button class="btn accent" id="loginBtn">Se connecter</button>
      </div>
      <p class="muted">Gratuit (Firebase Spark). Donn√©es en ligne, temps r√©el.</p>
    </section>

    <!-- App -->
    <section id="app" style="display:none">
      <!-- Home (TikTok-like feed) -->
      <section id="home" class="panel" style="padding:0">
        <div id="feed" class="feed"></div>
      </section>

      <!-- Publish -->
      <section id="publish" class="panel" style="display:none">
        <h2>Publier</h2>
        <textarea id="postText" placeholder="Exprime-toi‚Ä¶"></textarea>
        <input type="file" id="postMedia" accept="image/*,video/*"/>
        <div class="row">
          <button class="btn accent" id="publishBtn">Publier</button>
          <button class="btn danger" id="clearPublishBtn">Effacer</button>
        </div>
      </section>

      <!-- Popularity -->
      <section id="pop" class="panel" style="display:none">
        <h2>√ânergie de popularit√©</h2>
        <div class="battery">
          <div class="energy" id="energy"></div>
          <div class="spark"></div>
        </div>
        <canvas id="graph" width="1000" height="280"></canvas>
        <div class="legend">
          <div class="item"><span class="dot text"></span>Texte/Image/Photo</div>
          <div class="item"><span class="dot video"></span>Vid√©os</div>
          <div class="item"><span class="dot interact"></span>Interactions</div>
        </div>
      </section>

      <!-- Messages -->
      <section id="messages" class="panel" style="display:none">
        <h2>Messages</h2>
        <div class="row">
          <div class="contacts" id="contacts"></div>
          <div class="chatbox">
            <div class="chat" id="chat"></div>
            <div class="composer">
              <input id="dmText" placeholder="√âcrire un message‚Ä¶"/>
              <button class="btn accent" id="sendDMBtn">Envoyer</button>
              <button class="btn" id="recBtn">üéôÔ∏è</button>
              <input type="file" id="dmFile" accept="image/*,video/*,audio/*"/>
            </div>
            <div class="callbar">
              <button class="btn success" id="callAudioBtn">Appel audio</button>
              <button class="btn accent" id="callVideoBtn">Appel vid√©o</button>
              <button class="btn success" id="answerCallBtn">R√©pondre √† l‚Äôappel</button>
              <button class="btn danger" id="endCallBtn">Raccrocher</button>
            </div>
            <div class="rtc">
              <video id="localVideo" autoplay muted playsinline></video>
              <video id="remoteVideo" autoplay playsinline></video>
            </div>
          </div>
        </div>
      </section>

      <!-- Profile -->
      <section id="profile" class="panel" style="display:none">
        <h2>Profil</h2>
        <div class="profile-card">
          <div class="avatar">
            <img id="avatarImg" src="assets/placeholder-avatar.png" alt="Avatar" />
            <video id="avatarVideo" style="display:none" autoplay loop muted playsinline></video>
          </div>
          <div class="profile-info">
            <div><strong>Email:</strong> <span id="profileEmail">‚Äî</span></div>
            <div><strong>Popularit√©:</strong> <span id="profilePop">0</span></div>
          </div>
        </div>
        <div class="row">
          <input type="file" id="avatarFile" accept="image/*,video/*"/>
          <select id="avatarType">
            <option value="image">Photo de profil</option>
            <option value="video">Vid√©o de profil</option>
          </select>
          <button class="btn accent" id="saveAvatarBtn">Mettre √† jour</button>
        </div>
      </section>
    </section>
  </main>

  <div class="toast" id="toast"></div>

  <!-- App logic + Firebase -->
  <script type="module">
    /* Firebase SDKs */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getFirestore, collection, addDoc, doc, updateDoc, onSnapshot, query, orderBy, serverTimestamp, setDoc, getDoc, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    /* Config Firebase */
    const firebaseConfig = {
      apiKey: "AIzaSyDnxGbKIWzj2LKEwrh1a36z0jXMJfPEKTQ",
      authDomain: "viralplus-dfe4a.firebaseapp.com",
      projectId: "viralplus-dfe4a",
      storageBucket: "viralplus-dfe4a.appspot.com",
      messagingSenderId: "719277208432",
      appId: "1:719277208432:web:bf8585bfcf00962b87d5b5"
    };

    /* Init */
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    /* UI helpers */
    function notify(message){
      const t = document.getElementById("toast");
      const m = document.createElement("div");
      m.className = "msg";
      m.textContent = message;
      t.appendChild(m);
      setTimeout(()=>{ m.style.opacity = "0"; m.style.transform = "translateY(6px)"; }, 2200);
      setTimeout(()=>{ t.removeChild(m); }, 2800);
    }
    const tabs = document.querySelectorAll(".tab");
    const sections = ["home","publish","pop","messages","profile"];
    tabs.forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.dataset.tab;
        sections.forEach(s=>{
          document.getElementById(s).style.display = (s===id ? "block" : "none");
        });
        tabs.forEach(b=> b.classList.remove("active"));
        btn.classList.add("active");
      });
    });

    /* Auth */
    document.getElementById("signupBtn").onclick = signup;
    document.getElementById("loginBtn").onclick = login;

    async function signup(){
      const email = document.getElementById("auth-email").value.trim();
      const pass = document.getElementById("auth-pass").value.trim();
      if(!email || !pass){ notify("Remplis email et mot de passe"); return; }
      try{
        const cred = await createUserWithEmailAndPassword(auth, email, pass);
        await setDoc(doc(db, "profiles", cred.user.uid), {
          email, emailLower: email.toLowerCase(),
          createdAt: serverTimestamp(), pop: 0, avatarType: "image", avatarUrl: ""
        });
        notify("Compte cr√©√©");
      }catch(e){ notify("Erreur: " + e.message); }
    }
    async function login(){
      const email = document.getElementById("auth-email").value.trim();
      const pass = document.getElementById("auth-pass").value.trim();
      if(!email || !pass){ notify("Identifiants manquants"); return; }
      try{
        await signInWithEmailAndPassword(auth, email, pass);
        notify("Connect√©");
      }catch(e){ notify("Erreur: " + e.message); }
    }
    function enterApp(user){
      document.getElementById("auth").style.display = "none";
      document.getElementById("app").style.display = "block";
      document.getElementById("badge-user").textContent = user.email || "Utilisateur";
      subscribeFeed();
      subscribeContacts();
      subscribePopularity(user.uid);
      subscribeProfile(user.uid);
      try{ (adsbygoogle=window.adsbygoogle||[]).push({}); }catch(e){}
    }
    onAuthStateChanged(auth, (user)=>{
      if(user){ enterApp(user); } else {
        document.getElementById("auth").style.display = "block";
        document.getElementById("app").style.display = "none";
      }
    });

    /* Feed (TikTok-like) */
    const feedEl = document.getElementById("feed");
    function escapeHTML(s){ return s.replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m])); }
    function renderPost(docSnap){
      const p = docSnap.data();
      const d = document.createElement("div");
      d.className = "post";

      // Media
      let mediaNode = null;
      if(p.mediaUrl){
        if(p.mediaType && p.mediaType.startsWith("video")){
          const v = document.createElement("video");
          v.src = p.mediaUrl;
          v.controls = false;
          v.loop = true;
          v.muted = true;
          v.playsInline = true;
          mediaNode = v;
          // autoplay/pause selon visibilit√©
          const observer = new IntersectionObserver(entries=>{
            entries.forEach(entry=>{
              if(entry.isIntersecting){ v.play().catch(()=>{}); } else { v.pause(); }
            });
          }, { threshold: 0.6 });
          observer.observe(v);
        } else {
          const img = document.createElement("img");
          img.src = p.mediaUrl;
          mediaNode = img;
        }
      } else {
        const textOnly = document.createElement("div");
        textOnly.style.color = "#fff";
        textOnly.style.fontSize = "20px";
        textOnly.textContent = p.text || "";
        mediaNode = textOnly;
      }
      d.appendChild(mediaNode);

      // Overlay top (auteur + date)
      const date = p.createdAt?.toDate ? p.createdAt.toDate().toLocaleString() : "";
      const top = document.createElement("div");
      top.className = "overlay-top";
      top.innerHTML = `<div class="author">${p.authorEmail || "Anonyme"}</div><div class="muted">${date}</div>`;
      d.appendChild(top);

      // Overlay bottom (texte)
      const bottom = document.createElement("div");
      bottom.className = "overlay-bottom";
      bottom.innerHTML = `<div class="text">${p.text ? escapeHTML(p.text) : ""}</div>`;
      d.appendChild(bottom);

      // Actions overlay
      const actions = document.createElement("div");
      actions.className = "actions";
      actions.innerHTML = `
        <button class="btn like" title="Like">‚ù§Ô∏è</button>
        <button class="btn dislike" title="Dislike">üëé</button>
        <button class="btn comment" title="Commenter">üí¨</button>
        <button class="btn share" title="Partager">üîó</button>
        <button class="btn dm" title="DM">‚úâÔ∏è</button>
      `;
      actions.querySelector(".like").onclick = ()=> likePost(docSnap.id, (p.likes||0)+1);
      actions.querySelector(".dislike").onclick = ()=> dislikePost(docSnap.id, (p.dislikes||0)+1);
      actions.querySelector(".comment").onclick = ()=> commentPost(docSnap.id);
      actions.querySelector(".share").onclick = ()=> sharePost(p.text || "", location.href);
      actions.querySelector(".dm").onclick = ()=> openDM(p.authorUid);
      d.appendChild(actions);

      // Comments bubbles (affichage sous forme de bulles en overlay bas)
      if(p.comments && p.comments.length){
        const commentsWrap = document.createElement("div");
        commentsWrap.style.position = "absolute";
        commentsWrap.style.bottom = "16px";
        commentsWrap.style.right = "16px";
        commentsWrap.style.maxWidth = "28%";
        p.comments.slice(-3).forEach(c=>{
          const cc = document.createElement("div");
          cc.className = "bubble";
          cc.style.background = "rgba(0,0,0,.5)";
          cc.style.color = "#
            
link.textContent = " T√©l√©charger le fichier";
            link.href = data.content;
            link.target = "_blank";
            link.rel = "noopener";
            b.appendChild(link);
          }

          chatEl.appendChild(b);
        });
        chatEl.scrollTop = chatEl.scrollHeight;
      });
    }

    /* Envoi message texte */
    window.sendMessage = async function(){
      const input = document.getElementById("msgInput");
      if(!input || !input.value.trim() || !dmTarget || !auth.currentUser) return;

      const key = threadKey(auth.currentUser.uid, dmTarget);
      await addDoc(collection(db, "dm", key, "msgs"), {
        from: auth.currentUser.uid,
        type: "text",
        content: input.value.trim(),
        ts: serverTimestamp()
      });

      input.value = "";
    };

    /* Envoi fichier */
    window.sendFile = async function(file){
      if(!file || !dmTarget || !auth.currentUser) return;

      const storageRef = ref(storage, "dm/" + Date.now() + "_" + file.name);
      await uploadBytes(storageRef, file);
      const url = await getDownloadURL(storageRef);

      const key = threadKey(auth.currentUser.uid, dmTarget);
      await addDoc(collection(db, "dm", key, "msgs"), {
        from: auth.currentUser.uid,
        type: "file",
        content: url,
        ts: serverTimestamp()
      });
    };

    /* S√©curit√© : √©tat utilisateur */
    onAuthStateChanged(auth, (user)=>{
      if(user){
        subscribeContacts();
        subscribePopularity(user.uid);
      }
    });

  </script>
</body>
</html>
